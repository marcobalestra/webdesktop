const activateWindow=$w=>{var id=$w.attr("id");const uri=$w.attr("for"),dd=$(document.body).data("mabro");dd.activeWindow!==id&&(dd.activeApp===uri?activateDocument($w,id,uri):($(`.mabro-app.mabro-wrap:not([for="${uri}"])`).removeClass("active").addClass("inactive"),uri.endsWith("/webdestop/")&&$(`.mabro-app.mabro-wrap:not([for="${uri}"])`).hide(),$(`.mabro-app.mabro-wrap[for="${uri}"]`).addClass("active").show(),dd.activeApp=uri,1<$(`.mabro-app[for="${uri}"]:not(.mabro-wrap)`).length?($(document.body).data("mabro",dd),activateDocument($w,id,uri)):(dd.activeWindow=id,$(document.body).data("mabro",dd)),$(document.body).trigger("mabro:changedApp")))},activateDocument=($w,id,uri)=>{void 0===id&&(id=$w.attr("id")),void 0===uri&&(uri=$w.attr("for"));const dd=$(document.body).data("mabro");if(dd.activeWindow!=id){const $ws=$(`.mabro-app[for="${uri}"]:not(.mabro-wrap)`);if(!($ws.length<2)){$w.data("zIndex",1e4);const ws=[];$ws.each((idx,w)=>{ws.push({win:w,zIndex:$(w).data("zIndex")})}),ws.sort((a,b)=>{a.zIndex,b.zIndex}).map(x=>x.win).forEach((w,idx)=>{$(w).attr("z-index",idx).data("zIndex",idx)}),dd.activeWindow=id,$(document.body).data("mabro",dd)}}};$(document).on("click",".mabro-app:not(.mabro-wrap)",e=>{e.stopPropagation(),activateWindow($(e.target))});const makewrap=$w=>{$w=$(`<div class="mabro-app mabro-wrap" for="${$w}" id="${glob.uid("win-")}"></div>`);return $("body>.mabro-main-container>.mabro-main-wrap").append($w),$w},API=class{#sys;#app;constructor(sysapi){this.#sys=sysapi}init(){return this.#app||(this.#app=this.#sys.getApp()),this.#sys.wrap()}event(name,data){this.#app&&"function"==typeof this.#app.event&&this.#app.event(name,data)}windows(){return this.#sys.windows()}wrap(){return this.#sys.wrap()}},getClass=async mb=>{return class{#prop;#api;#app;constructor(){this.#prop={},this.#prop.mb=mb,this.#prop.wins=[]}async init(uri,manifest,options){if(this.#prop.uri=uri,this.#prop.manifest=manifest,options){if(options.system&&(this.#prop.system=!0),options.wrap){const $w=$(options.wrap);$w.attr("id")||$w.attr("id",glob.uid("win-")),$w.hasClass("mabro-app")||$w.addClass("mabro-app"),$w.hasClass("mabro-wrap")||$w.addClass("mabro-wrap"),$w.attr("for",this.#prop.uri),this.#prop.wrap=$w}this.#prop.options=options}else this.#prop.options={}}async dispatch(name,data){if(this.#app&&this.#prop.events&&"string"==typeof name&&!name.startsWith("private:")&&!name.startsWith("system:"))return await this.#app.event(name,data)}async event(name,data){return"run"===name&&await this.load(),this.dispatch(name,data)}getApp(){return this.#app}getAppApi(){return this.#api}getUri(){return this.#prop.uri}async load(){if(this.#app)return this.#app;if(!this.#prop.classfunc){const m=this.#prop.manifest;m.script.includes("<mjs_suffix>")&&(m.script=m.script.replace(/\<mjs_suffix\>/,this.#prop.mb.getProp("mjs_suffix")));let mod,cl;try{mod=await import(`${m.base_uri}${m.script}`)}catch(e){console.log("Error loading app script",m,e)}if(mod)try{"function"==typeof(cl=await mod.default(m))&&(this.#prop.classfunc=cl)}catch(e){console.log("Error loading app class",m,e)}}if(this.#prop.classfunc){this.#api||(this.#api=new API(this));try{this.#app=new this.#prop.classfunc(this.#api,this.#prop.options)}catch(e){console.log("Error loading app",e)}}return this.#app&&("function"==typeof this.#app.event&&(this.#prop.events=!0),this.#api.init(),this.#prop.mb.launchedApp(this.#prop.uri)),this.#app}windows(){return this.#prop.wins}wrap(){return this.#prop.wrap||(this.#prop.wrap=makewrap(this.#prop.uri)),this.#prop.wrap}}};export default getClass;