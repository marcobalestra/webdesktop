const triggerAll=(event,data)=>{$(document.body).trigger(`mabro:${event}`,data)},triggerApp=(uri,event,data)=>{$(`body > .mabro-main-container > .mabro-main-wrap > .mabro-wrap[for="${uri}"]`).trigger(`mabro:${event}`,data)},activateWindow=$w=>{var id=($w=!$w.hasClass(".mabro-window")?$w.closest(".mabro-window"):$w).attr("id"),uri=$w.attr("for");const dd=$(document.body).data("mabro");dd.activeWindow!==id&&(dd.activeApp===uri?activateDocument($w,id,uri):($(`.mabro-app.mabro-wrap:not([for="${uri}"])`).removeClass("mabro-active").addClass("mabro-inactive"),$(`.mabro-app.mabro-wrap[for="${uri}"]`).addClass("mabro-active"),dd.activeApp=uri,1<$(`.mabro-app.mabro-window[for="${uri}"]`).length?($(document.body).data("mabro",dd),activateDocument($w,id,uri)):($w.addClass("mabro-active"),dd.activeWindow=id,$(document.body).data("mabro",dd)),triggerAll("changedApp",{uri:uri}),triggerApp(uri,"activate")))},activateDocument=($w,id,uri)=>{$w.hasClass(".mabro-window")||($w=$w.closest(".mabro-window")),void 0===id&&(id=$w.attr("id")),void 0===uri&&(uri=$w.attr("for"));const dd=$(document.body).data("mabro");if(dd.activeWindow!==id){const $ws=$(`.mabro-app.mabro-window[for="${uri}"]`);if($ws.length<2)$w.addClass("mabro-active");else{$ws.removeClass("mabro-active"),$w.data("zIndex",1e4),$w.addClass("mabro-active");const ws=[];$ws.each((idx,w)=>{ws.push({win:w,zIndex:$(w).data("zIndex")})}),ws.sort((a,b)=>a.zIndex<b.zIndex?-1:1).map(x=>x.win).forEach((w,idx)=>{$(w).css("z-index",idx).data("zIndex",idx)}),dd.activeWindow=id,$(document.body).data("mabro",dd),triggerAll("changedWindow",{uri:uri,id:id}),triggerApp(uri,"changedWindow",{id:id})}}};glob.dd.get("mabro-window-drag")||glob.dd.set("mabro-window-drag",{data:d=>({ex0:d.event.pageX,ey0:d.event.pageY,x0:parseInt(d.element.css("left")),y0:parseInt(d.element.css("top")),minx:0,miny:0,maxx:d.element.closest(".mabro-wrap").width(),maxy:d.element.closest(".mabro-wrap").height()}),draggable:d=>{if(!d.element.hasClass("mabro-window-drag-inited")){d.element.attr("draggable",!1);const $tb=$(".mabro-window-titlebar",d.element);$tb.on("mouseenter",()=>{d.element.hasClass("mabro-fullscreen")||d.element.attr("draggable",!0)}),$tb.on("dblclick",e=>{e.preventDefault(),e.stopPropagation(),d.element.trigger("mabro:togglefs")}),$tb.on("mouseleave",()=>{d.element.attr("draggable",!1)}),d.element.addClass("mabro-window-drag-inited")}},dragstart:d=>(d.element.addClass("mabro-dragging mabro-gui-action"),!1),drag:d=>{if(d.element.hasClass("mabro-dragging")&&!(d.event.pageY<=0||d.event.pageX<=0))return d.element.css({top:String(Math.min(Math.max(d.data.y0+d.event.pageY-d.data.ey0,d.data.miny),d.data.maxy))+"px",left:String(Math.min(Math.max(d.data.x0+d.event.pageX-d.data.ex0,d.data.minx),d.data.maxx))+"px"}),!1},dragend:d=>{if(d.element.hasClass("mabro-dragging"))return d.element.removeClass("mabro-dragging mabro-gui-action"),d.element.trigger("mouseup"),!1}}),glob.dd.get("mabro-window-resize")||glob.dd.set("mabro-window-resize",{dropEffect:"none",dragImage:"none",data:d=>{const $w=d.element.closest(".mabro-window");var opts=$w.data("mabro-options");return{win:$w,ex0:d.event.pageX,ey0:d.event.pageY,x0:$w.width(),y0:$w.height(),minx:opts.minWidth?parseInt(opts.minWidth):197,miny:opts.minHeight?parseInt(opts.minHeight):55,maxx:opts.maxWidth?parseInt(opts.maxWidth):$w.closest(".mabro-wrap").width()-parseInt($w.css("left"))-100,maxy:opts.maxHeight?parseInt(opts.maxHeight):$w.closest(".mabro-wrap").height()-parseInt($w.css("top"))-100}},draggable:d=>{if(!d.element.hasClass("mabro-window-resize-inited")){d.element.attr("draggable",!1);const $w=d.element.closest(".mabro-window");d.element.on("mouseenter",()=>{$w.hasClass("mabro-fullscreen")||d.element.attr("draggable",!0)}),d.element.on("mouseleave",()=>{d.element.attr("draggable",!1)}),d.element.addClass("mabro-window-resize-inited")}},dragstart:d=>(d.data.win.addClass("mabro-resizing mabro-gui-action"),!1),drag:d=>{if(d.data.win&&d.data.win.hasClass("mabro-resizing")&&!(d.event.pageY<=0||d.event.pageX<=0))return d.data.win.css({width:String(Math.min(Math.max(d.data.x0+d.event.pageX-d.data.ex0,d.data.minx),d.data.maxx))+"px",height:String(Math.min(Math.max(d.data.y0+d.event.pageY-d.data.ey0,d.data.miny),d.data.maxy))+"px"}),!1},dragend:id=>{const w=id.data.win;if(w&&w.hasClass("mabro-resizing")){w.removeClass("mabro-resizing mabro-gui-action");var uri=w.attr("for"),id=w.attr("id");return triggerAll("changedWindow",{uri:uri,id:id}),triggerApp(uri,"changedWindow",{id:id}),!1}}});const MBWstatic={default:{width:"20%",height:"20%"},next:{top:20,left:20,step:20}},MBW=class{#sysapi;#prop;constructor(sysapi,options){this.#sysapi=sysapi,this.#prop={options:options||{}},void 0===this.#prop.options.title&&(this.#prop.options.title=sysapi.getAppName()),this.#prop.id=glob.uid("win-"),this.#prop.options.show&&setTimeout(()=>{this.show()},100)}static parseLeft=val=>(void 0===val&&((val=MBWstatic.next.left+MBWstatic.next.step)>=parseInt(window.innerWidth)/2&&(val=MBWstatic.next.top=MBWstatic.next.step),MBWstatic.next.left=val),MBW.parseSize(val));static parseSize=val=>(val="string"!=typeof val?String(val):val).match(/^[.0-9]+$/)?val+"px":val;static parseTop=val=>(void 0===val&&((val=MBWstatic.next.top+MBWstatic.next.step)>=parseInt(window.innerHeight)/2&&(val=MBWstatic.next.left=MBWstatic.next.step),MBWstatic.next.top=val),MBW.parseSize(val));static render=(wobj,sysapi,$resizer)=>{var uri=sysapi.getUri();const $w=$(`<div class="mabro-app mabro-window" for="${uri}" id="${$resizer.id}"></div>`),$title=$('<div class="title"></div>').append($("<label></label>").append($resizer.options.title));sysapi.getIcon()&&$title.prepend(sysapi.getIcon());const $titlebar=$('<div class="mabro-window-titlebar"></div>').append($title);if(!$resizer.options.cantClose){const $closer=$('<span class="mabro-win-button mabro-close-button"></span>');$w.on("mabro:close",()=>{sysapi.closeWindow(wobj)}),$closer.on("click",()=>{$w.trigger("mabro:close")}),$titlebar.append($closer)}if(!$resizer.options.fixedSize){const $fstoggler=$('<span class="mabro-win-button mabro-zoom-button"></span>');$fstoggler.on("click",()=>{$w.trigger("mabro:togglefs")}),$w.on("mabro:togglefs",()=>{wobj.toggleFullscreen()}),$titlebar.append($fstoggler)}$w.append($titlebar);const $c=$('<div class="mabro-window-content"></div>');return $resizer.options.cssBase&&$c.addClass($resizer.options.cssBase),$w.css({width:MBW.parseSize($resizer.options.width||MBWstatic.default.width),height:MBW.parseSize($resizer.options.height||MBWstatic.default.height),top:MBW.parseTop($resizer.options.top),left:MBW.parseLeft($resizer.options.left)}),$w.append($c),$w.hide(),$w.data("mabro-options",$resizer.options),sysapi.wrap().append($w),$resizer.options.fullscreen&&wobj.toggleFullscreen(!0,$w),$resizer.options.fixedSize||($resizer=$('<span class="mabro-win-button mabro-resize-button"></span>'),$w.append($resizer),setTimeout(()=>{glob.dd.get("mabro-window-resize").draggable($(".mabro-resize-button",$w))},1)),setTimeout(()=>{glob.dd.get("mabro-window-drag").draggable($w)},1),$w};active(){return this.wrap().hasClass("mabro-active")}top(x){this.wrap().css("top",MBW.parseSize(x))}left(x){this.wrap().css("left",MBW.parseSize(x))}width(x){this.wrap().css("width",MBW.parseSize(x))}height(x){this.wrap().css("height",MBW.parseSize(x))}show(){this.toggle(!0)}hide(){this.toggle(!1)}toggle(status){const $w=this.wrap();$w.toggle(!!status),$(document.body).trigger("mabro:changedWindow",{uri:$w.attr("for"),id:$w.attr("id")})}toggleFullscreen(ps,$w){void 0===ps?ps=this.#prop.fullscreen=!this.#prop.fullscreen:this.#prop.fullscreen=!!ps,void 0===$w&&($w=this.wrap()),ps?($w.data("mabro-winsize",{top:$w.css("top"),left:$w.css("left"),width:$w.css("width"),height:$w.css("height")}),$w.css({top:"",left:"",width:"",height:""}).addClass("mabro-fullscreen")):(ps=$w.data("mabro-winsize"),$w.css({top:ps.top,left:ps.left,width:ps.width,height:ps.height}).removeClass("mabro-fullscreen"),$w.removeData("mabro-winsize")),$(document.body).trigger("mabro:changedWindow",{uri:$w.attr("for"),id:$w.attr("id")})}title(t){return"string"!=typeof t?this.#prop.options.title:(this.#prop.options.title=t,this.wrap().children(".mabro-title-bar").children("label").html(t),t)}wrap(){return this.#prop.w||(this.#prop.w=MBW.render(this,this.#sysapi,this.#prop)),this.#prop.w}window(){return this.wrap().children(".mabro-window-content")}close(){this.#sysapi.closeWindow(this)}},API=class{#sys;#app;constructor(sysapi){this.#sys=sysapi}init(){return this.#app||(this.#app=this.#sys.getApp()),"function"==typeof this.#app.init&&setTimeout(()=>{this.#app.init()},100),this.#sys.wrap()}async dialog(options){return await this.#sys.dialog(options)}windows(){return this.#sys.windows()}frontmostWindow(){return this.#sys.frontmostWindow()}wrap(){return this.#sys.wrap()}menubar(data){this.#sys.makeMenuBar(data)}newWindow(options){return this.#sys.newWindow(options)}closeWindow(w){return this.#sys.closeWindow(w)}quit(){this.#sys.quit()}},getClass=async mb=>{return class{#prop;#api;#app;constructor(){this.#prop={},this.#prop.mb=mb,this.#prop.wins=[]}async init(uri,manifest,options){if(this.#prop.uri=uri,this.#prop.manifest=manifest,options){if(options.system&&(this.#prop.system=!0,options.sysapi=this,options.windowClass=MBW),options.wrap){const $w=$(options.wrap);$w.attr("id")||$w.attr("id",glob.uid("win-")),$w.hasClass("mabro-app")||$w.addClass("mabro-app"),$w.hasClass("mabro-wrap")||$w.addClass("mabro-wrap"),$w.attr("for",this.#prop.uri),this.#prop.wrap=$w}this.#prop.options=options}else this.#prop.options={}}async dispatch(name,data){if(this.#app&&this.#prop.events&&"string"==typeof name&&!name.startsWith("private:")&&!name.startsWith("system:"))return await this.#app.event(name,data)}async event(name,data){if("run"===name)await this.load();else if("quit"===name)return this.quit();return this.dispatch(name,data)}getApp(){return this.#app}getIcon(){return this.#prop.manifest?this.#prop.manifest.app_icon:void 0}getManifest(){return this.#prop.manifest}getAppName(){return this.#prop.manifest.app_name}getAppApi(){return this.#api}getUri(){return this.#prop.uri}isSystem(){return!!this.#prop.system}async load(){if(this.#app)return this.activate(),this.#app;if(!this.#prop.classfunc){const m=this.#prop.manifest;m.css&&("string"==typeof m.css&&(m.css=[m.css]),await m.css.forEachAwait(async u=>{u.match(/^([^:]+:\/\/|\/)/)||(u=`${m.base_uri}${u}`),await this.#prop.mb.loadCSS(u)})),m.script.includes("<mjs_suffix>")&&(m.script=m.script.replace(/<mjs_suffix>/,this.#prop.mb.getProp("mjs_suffix")));let mod,cl;try{mod=await import(`${m.base_uri}${m.script}`)}catch(e){console.log("Error loading app script",m,e)}if(mod)try{"function"==typeof(cl=await mod.default(m))&&(this.#prop.classfunc=cl)}catch(e){console.log("Error loading app class",m,e)}}if(this.#prop.classfunc){this.#api||(this.#api=new API(this));try{this.#app=new this.#prop.classfunc(this.#api,this.#prop.options)}catch(e){console.log("Error loading app",e)}}return this.#app&&("function"==typeof this.#app.event&&(this.#prop.events=!0),this.makeMenuBar(),this.#api.init(),this.#prop.mb.launchedApp(this.#prop.uri)),this.#app}makeMenuBar(data){if(data){if(!data&&"object"==typeof data)return;data=(data=!Array.isArray(data)?[data]:data).filter(d=>d.label&&d.items)}else data=[];this.#prop.mb.getMenu().then(m=>{m.registerMenuBar(this,data)})}windows(){return this.#prop.wins}newWindow(idx){void 0===(idx=void 0===idx?{}:idx).cssBase&&this.#prop.manifest.cssBase&&(idx.cssBase=this.#prop.manifest.cssBase);const w=new MBW(this,idx);this.#prop.wins.push(w);idx=this.#prop.wins.length;return w.wrap().css("z-index",idx).data("zIndex",idx),activateWindow(w.wrap()),w}closeWindow(w){if(w="string"==typeof w?this.winById(w):w){const $w=w.wrap(),id=$w.attr("id");triggerApp($w.attr("for"),"closeWindow",{id:id}),$w.remove(),this.#prop.wins=this.#prop.wins.filter(w=>w.wrap().attr("id")!==id);const fm=this.frontmostWindow();fm?activateWindow(fm.wrap()):this.#prop.system||this.#prop.manifest.windowless||this.quit()}}frontmostWindow(){const wins=this.windows();if(wins.length){if(1===wins.length)return wins[0];let dw,w,z=-1;return wins.forEach(wi=>{if(!dw){const $w=wi.wrap();$w.hasClass("mabro-active")&&(dw=w=wi);var zi=$w.data("zIndex");zi>z&&(z=zi,w=wi)}}),w&&!dw&&(dw=w),dw}}winById(id){const wins=this.windows();if(wins.length){let w;return wins.forEach(wi=>{w||wi.wrap().attr("id")===id&&(w=wi)}),w}}activate(){const dd=$(document.body).data("mabro");dd.activeApp=this.#prop.uri;const w=this.frontmostWindow();w?dd.activeWindow=w.wrap().attr("id"):dd.activeWindow="-",$(`.mabro-app.mabro-wrap:not([for="${this.#prop.uri}"])`).removeClass("mabro-active").addClass("mabro-inactive"),$(`.mabro-app.mabro-wrap[for="${this.#prop.uri}"]`).removeClass("mabro-inactive").addClass("mabro-active"),$(document.body).data("mabro",dd)}activateWindow(w){activateWindow(w.wrap())}quit(){this.#prop.quitting||(this.#prop.quitting=!0,this.#prop.wrap&&this.#prop.wrap.remove(),this.#prop.mb.quitapp(this.#prop.uri),this.#app=!1,this.#api=!1)}wrap(){var $w;return this.#prop.wrap||($w=$(`<div class="mabro-app mabro-wrap" for="${this.#prop.uri}" id="${glob.uid("win-")}"></div>`),$("body>.mabro-main-container>.mabro-main-wrap").append($w),this.#prop.wrap=$w,this.activate()),this.#prop.wrap}async dialog(options){return await this.#prop.mb.dialog(options)}}};$("body>.mabro-main-container").hasClass("mabro-api-inited")||(document.addEventListener("dragover",e=>{e.preventDefault()}),$(document).on("mouseup",".mabro-app.mabro-window:not(.mabro-gui-action)",e=>{e.stopPropagation(),activateWindow($(e.target))}),$("body>.mabro-main-container").addClass("mabro-api-inited"));export default getClass;