document.addEventListener("dragover",e=>{e.preventDefault()});const activateWindow=$w=>{var id=($w=!$w.hasClass(".mabro-window")?$w.closest(".mabro-window"):$w).attr("id");const uri=$w.attr("for"),dd=$(document.body).data("mabro");dd.activeWindow!==id&&(dd.activeApp===uri?activateDocument($w,id,uri):($(`.mabro-app.mabro-wrap:not([for="${uri}"])`).removeClass("mabro-active").addClass("mabro-inactive"),uri.endsWith("/webdestop/")&&$(`.mabro-app.mabro-wrap:not([for="${uri}"])`).hide(),$(`.mabro-app.mabro-wrap[for="${uri}"]`).addClass("mabro-active").show(),dd.activeApp=uri,1<$(`.mabro-app.mabro-window[for="${uri}"]`).length?($(document.body).data("mabro",dd),activateDocument($w,id,uri)):($w.addClass("mabro-active"),dd.activeWindow=id,$(document.body).data("mabro",dd)),$(document.body).trigger("mabro:changedApp",{uri:uri})))},activateDocument=($w,id,uri)=>{$w.hasClass(".mabro-window")||($w=$w.closest(".mabro-window")),void 0===id&&(id=$w.attr("id")),void 0===uri&&(uri=$w.attr("for"));const dd=$(document.body).data("mabro");if(dd.activeWindow!=id){const $ws=$(`.mabro-app.mabro-window[for="${uri}"]`);if($ws.length<2)$w.addClass("mabro-active");else{$ws.removeClass("mabro-active"),$w.data("zIndex",1e4),$w.addClass("mabro-active");const ws=[];$ws.each((idx,w)=>{ws.push({win:w,zIndex:$(w).data("zIndex")})}),ws.sort((a,b)=>a.zIndex<b.zIndex?-1:1).map(x=>x.win).forEach((w,idx)=>{$(w).css("z-index",idx).data("zIndex",idx)}),dd.activeWindow=id,$(document.body).data("mabro",dd).trigger("mabro:changedWindow",{uri:uri,id:id})}}};$(document).on("mouseup",".mabro-app.mabro-window:not(.mabro-gui-action)",e=>{e.stopPropagation(),activateWindow($(e.target))});const makeDraggableWindow=$w=>{const $tb=$(".mabro-window-titlebar",$w);$tb.on("mouseenter",()=>{$w.hasClass("mabro-fullscreen")||$w.attr("draggable",!0)}),$tb.on("dblclick",e=>{e.preventDefault(),e.stopPropagation(),$w.trigger("mabro:togglefs")}),$tb.on("mouseleave",()=>{$w.attr("draggable",!1)});const w=$w.get(0);w.addEventListener("dragstart",ddata=>{if("true"===$w.attr("draggable")){ddata.stopPropagation(),activateWindow($w);ddata={ex0:ddata.pageX,ey0:ddata.pageY,x0:parseInt($w.css("left")),y0:parseInt($w.css("top")),minx:0,miny:0,maxx:$w.closest(".mabro-wrap").width(),maxy:$w.closest(".mabro-wrap").height()};return $w.data("mabro-drag",ddata),$w.addClass("mabro-dragging mabro-gui-action"),!1}},!0),w.addEventListener("drag",e=>{if($w.hasClass("mabro-dragging")&&(e.preventDefault(),e.stopPropagation(),!(e.pageY<=0||e.pageX<=0))){var ddata=$w.data("mabro-drag");return $w.css({top:String(Math.min(Math.max(ddata.y0+e.pageY-ddata.ey0,ddata.miny),ddata.maxy))+"px",left:String(Math.min(Math.max(ddata.x0+e.pageX-ddata.ex0,ddata.minx),ddata.maxx))+"px"}),!1}},!0),w.addEventListener("dragend",e=>{if($w.hasClass("mabro-dragging"))return e.preventDefault(),e.stopPropagation(),$w.removeData("mabro-drag"),$w.removeClass("mabro-dragging mabro-gui-action"),$(document.body).trigger("mabro:changedWindow",{uri:$w.attr("for"),id:$w.attr("id")}),!1},!0)},makeResizeableWindow=$w=>{const $rb=$(".mabro-resize-button",$w);$rb.on("mouseenter",()=>{$w.hasClass("mabro-fullscreen")||$rb.attr("draggable",!0)}),$rb.on("mouseleave",()=>{$rb.attr("draggable",!1)});$w.get(0);const rb=$rb.get(0);rb.addEventListener("dragstart",e=>{if("true"===$rb.attr("draggable")){e.stopPropagation();var ddata=$w.data("mabro-options"),ddata={ex0:e.pageX,ey0:e.pageY,x0:$w.width(),y0:$w.height(),minx:ddata.minWidth?parseInt(ddata.minWidth):197,miny:ddata.minHeight?parseInt(ddata.minHeight):55,maxx:ddata.maxWidth?parseInt(ddata.maxWidth):$w.closest(".mabro-wrap").width()-parseInt($w.css("left")),maxy:ddata.maxHeight?parseInt(ddata.maxHeight):$w.closest(".mabro-wrap").height()-parseInt($w.css("top"))};return $w.data("mabro-resize",ddata),$w.addClass("mabro-resizing mabro-gui-action"),!1}},!0),rb.addEventListener("drag",e=>{if($w.hasClass("mabro-resizing")&&(e.preventDefault(),e.stopPropagation(),!(e.pageY<=0||e.pageX<=0))){var ddata=$w.data("mabro-resize");return $w.css({width:String(Math.min(Math.max(ddata.x0+e.pageX-ddata.ex0,ddata.minx),ddata.maxx))+"px",height:String(Math.min(Math.max(ddata.y0+e.pageY-ddata.ey0,ddata.miny),ddata.maxy))+"px"}),!1}},!0),rb.addEventListener("dragend",e=>{if($w.hasClass("mabro-resizing"))return e.preventDefault(),e.stopPropagation(),$w.removeData("mabro-resize"),$w.removeClass("mabro-resizing mabro-gui-action"),$(document.body).trigger("mabro:changedWindow",{uri:$w.attr("for"),id:$w.attr("id")}),!1},!0)},MBWstatic={default:{width:"20%",height:"20%"},next:{top:20,left:20,step:20}},MBW=class{#sysapi;#prop;constructor(sysapi,options){this.#sysapi=sysapi,this.#prop={options:options||{}},void 0===this.#prop.options.title&&(this.#prop.options.title=sysapi.getAppName()),this.#prop.id=glob.uid("win-"),this.#prop.options.show&&setTimeout(()=>{this.show()},100)}static parseLeft=val=>(void 0===val&&((val=MBWstatic.next.left+MBWstatic.next.step)>=parseInt(window.innerWidth)/2&&(val=MBWstatic.next.step),MBWstatic.next.left=val),MBW.parseSize(val));static parseSize=val=>(val="string"!=typeof val?String(val):val).match(/^[.0-9]+$/)?val+"px":val;static parseTop=val=>(void 0===val&&((val=MBWstatic.next.top+MBWstatic.next.step)>=parseInt(window.innerHeight)/2&&(val=MBWstatic.next.step),MBWstatic.next.top=val),MBW.parseSize(val));static render=(wobj,sysapi,$resizer)=>{const $w=$(`<div class="mabro-app mabro-window" for="${sysapi.getUri()}" id="${$resizer.id}"></div>`),$titlebar=$('<div class="mabro-window-titlebar"></div>').append($("<label></label>").append($resizer.options.title));if(!$resizer.options.cantClose){const $closer=$('<span class="mabro-win-button mabro-close-button"></span>');$w.on("mabro:close",()=>{sysapi.closeWindow(wobj)}),$closer.on("click",()=>{$w.trigger("mabro:close")}),$titlebar.append($closer)}if(!$resizer.options.fixedSize){const $fstoggler=$('<span class="mabro-win-button mabro-zoom-button"></span>');$fstoggler.on("click",()=>{$w.trigger("mabro:togglefs")}),$w.on("mabro:togglefs",()=>{wobj.toggleFullscreen()}),$titlebar.append($fstoggler)}$w.append($titlebar);const $c=$('<div class="mabro-window-content"></div>');return $resizer.options.cssBase&&$c.addClass($resizer.options.cssBase),$w.css({width:MBW.parseSize($resizer.options.width||MBWstatic.default.width),height:MBW.parseSize($resizer.options.height||MBWstatic.default.height),top:MBW.parseTop($resizer.options.top),left:MBW.parseLeft($resizer.options.left)}),$w.append($c),$w.hide(),$w.data("mabro-options",$resizer.options),sysapi.wrap().append($w),$resizer.options.fullscreen&&wobj.toggleFullscreen(!0,$w),$resizer.options.fixedSize||($resizer=$('<span class="mabro-win-button mabro-resize-button"></span>'),$w.append($resizer),makeResizeableWindow($w)),makeDraggableWindow($w),$w};top(x){this.wrap().css("top",MBW.parseSize(x))}left(x){this.wrap().css("left",MBW.parseSize(x))}width(x){this.wrap().css("width",MBW.parseSize(x))}height(x){this.wrap().css("height",MBW.parseSize(x))}show(){this.toggle(!0)}hide(){this.toggle(!1)}toggle(status){this.wrap().toggle(!!status)}toggleFullscreen(ps,$w){void 0===ps?ps=this.#prop.fullscreen=!this.#prop.fullscreen:this.#prop.fullscreen=!!ps,void 0===$w&&($w=this.wrap()),ps?($w.data("mabro-winsize",{top:$w.css("top"),left:$w.css("left"),width:$w.css("width"),height:$w.css("height")}),$w.css({top:"",left:"",width:"",height:""}).addClass("mabro-fullscreen")):(ps=$w.data("mabro-winsize"),$w.css({top:ps.top,left:ps.left,width:ps.width,height:ps.height}).removeClass("mabro-fullscreen"),$w.removeData("mabro-winsize"))}title(t){return"string"!=typeof t?this.#prop.options.title:(this.#prop.options.title=t,this.wrap().children(".mabro-title-bar").children("label").html(t),t)}wrap(){return this.#prop.w||(this.#prop.w=MBW.render(this,this.#sysapi,this.#prop)),this.#prop.w}window(){return this.wrap().children(".mabro-window-content")}},API=class{#sys;#app;constructor(sysapi){this.#sys=sysapi}init(){return this.#app||(this.#app=this.#sys.getApp()),"function"==typeof this.#app.init&&setTimeout(()=>{this.#app.init()},100),this.#sys.wrap()}event(name,data){this.#app&&"function"==typeof this.#app.event&&this.#app.event(name,data)}windows(){return this.#sys.windows()}frontmostWindow(){return this.#sys.frontmostWindow()}wrap(){return this.#sys.wrap()}menubar(data){this.#sys.makeMenuBar(data)}newWindow(options){return this.#sys.newWindow(options)}closeWindow(w){return this.#sys.closeWindow(w)}quit(){this.#sys.quit()}},getClass=async mb=>{return class{#prop;#api;#app;constructor(){this.#prop={},this.#prop.mb=mb,this.#prop.wins=[]}async init(uri,manifest,options){if(this.#prop.uri=uri,this.#prop.manifest=manifest,options){if(options.system&&(this.#prop.system=!0),options.wrap){const $w=$(options.wrap);$w.attr("id")||$w.attr("id",glob.uid("win-")),$w.hasClass("mabro-app")||$w.addClass("mabro-app"),$w.hasClass("mabro-wrap")||$w.addClass("mabro-wrap"),$w.attr("for",this.#prop.uri),this.#prop.wrap=$w}this.#prop.options=options}else this.#prop.options={}}async dispatch(name,data){if(this.#app&&this.#prop.events&&"string"==typeof name&&!name.startsWith("private:")&&!name.startsWith("system:"))return await this.#app.event(name,data)}async event(name,data){if("run"===name)await this.load();else if("quit"===name)return this.quit();return this.dispatch(name,data)}getApp(){return this.#app}getAppName(){return this.#prop.manifest.app_name}getAppApi(){return this.#api}getUri(){return this.#prop.uri}async load(){if(this.#app)return this.activate(),this.#app;if(!this.#prop.classfunc){const m=this.#prop.manifest;m.css&&("string"==typeof m.css&&(m.css=[m.css]),await m.css.forEachAwait(async u=>{u.match(/^([^:]+:\/\/|\/)/)||(u=`${m.base_uri}${u}`),await this.#prop.mb.loadCSS(u)})),m.script.includes("<mjs_suffix>")&&(m.script=m.script.replace(/\<mjs_suffix\>/,this.#prop.mb.getProp("mjs_suffix")));let mod,cl;try{mod=await import(`${m.base_uri}${m.script}`)}catch(e){console.log("Error loading app script",m,e)}if(mod)try{"function"==typeof(cl=await mod.default(m))&&(this.#prop.classfunc=cl)}catch(e){console.log("Error loading app class",m,e)}}if(this.#prop.classfunc){this.#api||(this.#api=new API(this));try{this.#app=new this.#prop.classfunc(this.#api,this.#prop.options)}catch(e){console.log("Error loading app",e)}}return this.#app&&("function"==typeof this.#app.event&&(this.#prop.events=!0),this.makeMenuBar(),this.#api.init(),this.#prop.mb.launchedApp(this.#prop.uri)),this.#app}makeMenuBar(data){if(data){if(!data&&"object"==typeof data)return;data=(data=!Array.isArray(data)?[data]:data).filter(d=>d.label&&d.items)}else data=[];if(!this.#prop.system&&(data[0]||(data[0]={}),data[0]))if(data[0].label=_l("menu-File"),data[0].items||(data[0].items=[]),"function"==typeof data[0].items){const f=data[0].items;data[0].items=()=>{const out=f.call();return out=out||[],Array.isArray(out)||(out=[out]),out.length&&out.push("-"),out.push({label:_l("menu-Quit"),action:()=>{this.quit()}}),out}}else Array.isArray(data[0].items)&&(data[0].items.length&&data[0].items.push("-"),data[0].items.push({label:_l("menu-Quit"),action:()=>{this.quit()}}));this.#prop.mb.getMenu().then(m=>{m.registerMenuBar(this.#prop.uri,data)})}windows(){return this.#prop.wins}newWindow(idx){void 0===(idx=void 0===idx?{}:idx).cssBase&&this.#prop.manifest.cssBase&&(idx.cssBase=this.#prop.manifest.cssBase);const w=new MBW(this,idx);this.#prop.wins.push(w);idx=this.#prop.wins.length;return w.wrap().css("z-index",idx).data("zIndex",idx),activateWindow(w.wrap()),w}closeWindow(w){if(w="string"==typeof w?this.winById(w):w){const $w=w.wrap(),id=$w.attr("id");$w.remove(),this.#prop.wins=this.#prop.wins.filter(w=>w.wrap().attr("id")!==id);const fm=this.frontmostWindow();fm?activateWindow(fm.wrap()):this.quit()}}frontmostWindow(){const wins=this.windows();if(wins.length){if(1==wins.length)return wins[0];let dw,w,z=-1;return wins.forEach(wi=>{if(!dw){const $w=wi.wrap();$w.hasClass("mabro-active")&&(dw=w=wi);var zi=$w.data("zIndex");zi>z&&(z=zi,w=wi)}}),w&&!dw&&(dw=w),dw}}winById(id){const wins=this.windows();if(wins.length){let w;return wins.forEach(wi=>{w||wi.wrap().attr("id")==id&&(w=wi)}),w}}activate(){const dd=$(document.body).data("mabro");dd.activeApp=this.#prop.uri;const w=this.frontmostWindow();w?dd.activeWindow=w.wrap().attr("id"):dd.activeWindow="-",$(`.mabro-app.mabro-wrap:not([for="${this.#prop.uri}"])`).removeClass("mabro-active").addClass("mabro-inactive"),$(`.mabro-app.mabro-wrap[for="${this.#prop.uri}"]`).removeClass("mabro-inactive").addClass("mabro-active"),$(document.body).data("mabro",dd)}quit(){this.#prop.quitting||(this.#prop.quitting=!0,this.#prop.wrap&&this.#prop.wrap.remove(),this.#prop.mb.quitapp(this.#prop.uri),this.#app=!1,this.#api=!1)}wrap(){var $w;return this.#prop.wrap||($w=$(`<div class="mabro-app mabro-wrap" for="${this.#prop.uri}" id="${glob.uid("win-")}"></div>`),$("body>.mabro-main-container>.mabro-main-wrap").append($w),this.#prop.wrap=$w,this.activate()),this.#prop.wrap}}};export default getClass;