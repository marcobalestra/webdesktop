const initFs=async mb=>{if(glob.localize.loaded){const fs=await mb.getFs();var $ntb=fs.existingStorages();if(1==$ntb.length)return fs.init($ntb[0]),void mb.start();const $dlog=await mb.plugin("dialog",{canclose:!1}),$body=$dlog.body();let secured=!1;0==$ntb.length?$dlog.title(_l("StoragesNotFound")):$dlog.title(_l("StoragesMultiFound"));var $lsb=glob.uid("btn"),$ntb=$(`<p><input name="secured" checked="checked" type="radio" id="${$lsb}"><label for="${$lsb}"> <b>${_l("ComputerNotTrusted")}</b></label><br /><i>“${_l("ComputerNotTrustedDesc")}”</i><small style="display:block;font-size:75%;">${_l("ComputerNotTrustedHelp")}</small></p>`);$("input",$ntb).on("click",()=>{secured=!1});$lsb=glob.uid("btn"),$lsb=$(`<p><input name="secured" type="radio" id="${$lsb}"><label for="${$lsb}"> <b>${_l("ComputerIsTrusted")}</b></label><br /><i>“${_l("ComputerIsTrustedDesc")}”</i><small style="display:block;font-size:75%;">${_l("ComputerIsTrustedHelp")}</small></p>`);$("input",$lsb).on("click",()=>{secured=!0}),$body.append($("<p></p>").append(_l("Privacy level"),":")),$body.append($('<form class="d-block ml-4"></form>').append($ntb,$lsb)),$body.append($("<div></div>").append(_l("ComputerChoiceCanSaveSession")));$lsb=$(`<button type="button" class="btn btn-secondary mr-auto">${_l("StorageInitLoad")}</button>`);const $nsb=$(`<button type="button" class="btn btn-primary">${_l("StorageInitNew")}</button>`);$nsb.on("click",async()=>{$dlog.body(_l("Operation in progress")),$dlog.footer(""),await fs.init(secured?"local":"session"),$dlog.close(),mb.start()}),$dlog.footer().append($lsb,$nsb),$dlog.open()}else setTimeout(()=>{initFs(mb)},100)},existingStorages=()=>{const out=[];return window.sessionStorage.getItem("mabro")&&out.push("session"),window.localStorage.getItem("mabro")&&out.push("local"),out},getClass=async mb=>{return class{#prop;#storage;#data;constructor(manifest){this.#prop={},this.#prop.manifest=manifest,this.#prop.mb=mb,this.#prop.myuri=manifest.base_uri}async boot(){initFs(mb)}async init(mode){this.#storage="local"===mode?window.localStorage:window.sessionStorage,this.#storage.getItem("mabro")?this.#data=JSON.parse(this.#storage.getItem("mabro")):(this.#data=await glob.get(this.#prop.myuri+"skeleton.json"),console.log(this.#prop),this.commit())}commit(force){this.#prop.commitTimeout&&(clearTimeout(this.#prop.commitTimeout),delete this.#prop.commitTimeout),force?this.#storage.setItem("mabro",JSON.stringify(this.#data)):this.#prop.commitTimeout=setTimeout(()=>{this.commit(!0)},1e3)}existingStorages(){return existingStorages()}}};export default getClass;