const cache={labels:{},icons:{},buttons:{},tb:{}};glob.dd.set("wd-icon",{effectAllowed:"move",data:d=>{const $i=d.element;let obj=d.data&&"object"==typeof d.data?d.data:void 0;if(!obj&&$i.attr("fsid")&&$i.attr("fstype"))switch($i.attr("fstype")){case"folder":obj=cache.fs.getDir($i.attr("fsid"));break;case"file":obj=cache.fs.getFile($i.attr("fsid"))}return obj},dragstart:d=>{d.element.css({opacity:".5","background-color":"transparent"})},dragend:d=>{d.element.css({opacity:"","background-color":""})},canaccept:d=>{var fsid=d.target.attr("fsid");if(fsid===d.data.parent)return!1;const list=cache.fs.listAncestors(fsid,[fsid]);return!list.includes(d.data.id)},drop:type=>{const ele=type.data,tgt=cache.fs.getDir(type.target.attr("fsid")),parent=cache.fs.getDir(ele.parent);"trash"!==tgt.role?(type=ele.id.startsWith("dir-")?"folder":"file",delete ele.deleted,ele.parent=tgt.id,"file"==type?(parent.files=parent.files.filter(x=>x!==ele.id),Array.isArray(tgt.files)||(tgt.files=[]),tgt.files.push(ele.id),cache.fs.setFile(ele)):(parent.dirs=parent.dirs.filter(x=>x!==ele.id),Array.isArray(tgt.dirs)||(tgt.dirs=[]),tgt.dirs.push(ele.id),cache.fs.setDir(ele)),cache.fs.setDir(tgt),cache.fs.setDir(parent),cache.wd.refreshWindowByFsid(tgt.id),cache.wd.refreshWindowByFsid(parent.id)):cache.wd.trashItem(ele.id)}});const getLabel=l=>cache.labels[l]||(cache.labels[l]=_l(l)),getIcon=l=>cache.icons[l]||(cache.icons[l]=_icon(l)),getButton=l=>{if(!cache.buttons[l]){const $d=$("<div></div>");$d.append($('<button type="button" class="btn"></button>').addClass(l).attr("title",getLabel(l)).append(getIcon(l))),cache.buttons[l]=$d.html()}return cache.buttons[l]},getFolderToolbar=(w,f)=>{const $out=$("<div></div>");if(!cache.tb.folder){const $d=$('<div class="btn-toolbar" role="toolbar"></div>'),$g1=$('<div class="btn-group" role="group">');$g1.append(getButton("wd-parent-folder")),$d.append($g1);const $g2=$('<div class="btn-group" role="group">');$g2.append(getButton("wd-view-thumbnails")),$g2.append(getButton("wd-view-list")),$d.append($g2),cache.tb.folder=$d.prop("outerHTML")}$out.append(cache.tb.folder);const wdata=w.wrap().data("wd-nav")||{},setView=v=>{wdata.view=v,w.wrap().data("wd-nav",wdata),makeFolderWindow(w,f)};f.parent?$("button.wd-parent-folder",$out).on("click",async()=>{await cache.wd.openFolder(f.parent),cache.wd.selectIconByFsId(f.id)}):$("button.wd-parent-folder",$out).parent().remove(),"list"===wdata.view?($("button.wd-view-list",$out).addClass("active"),$("button.wd-view-thumbnails",$out).on("click",()=>{setView("thumbnails")})):($("button.wd-view-thumbnails",$out).addClass("active"),$("button.wd-view-list",$out).on("click",()=>{setView("list")}));var svg=svgByFs(f);let ti;return svg.lock?($out.append($('<div class="wd-view-folder-lock"></div>').append(svg.lock)),ti=svg.lock):svg.icon&&(ti=svg.icon),ti&&($(".mabro-window-titlebar .title svg",w.wrap()).remove(),$(".mabro-window-titlebar .title",w.wrap()).prepend(ti)),$out},makeFolderWindow=(wobj,folder)=>{const $w=(wobj=wobj instanceof jQuery?cache.wd.winById(wobj.closest(".mabro-window").attr("id")):wobj).wrap();void 0===folder?folder=cache.fs.getDir($w.attr("fsid")):$w.attr("fsid")||$w.addClass("wd-folder-window").attr("fsid",folder.id).attr("fstype","folder");var wdata=$w.data("wd-nav")||{};const $c=wobj.window();$c.empty(),$c.append($('<div class="wd-nav-bar"></div>').append(getFolderToolbar(wobj,folder)));const $list=$(`<div class="wd-content wd-content-${wdata.view||"thumbnails"}"></div>`);return Array.isArray(folder.dirs)&&folder.dirs.map(d=>cache.fs.getDir(d)).cisort("name").forEach(d=>{if(d&&(!d.deleted||"trash"===folder.role)){const i=new WDICON({node:d,type:"folder",label:d.name,id:d.id});$list.append(i.get())}}),Array.isArray(folder.files)&&folder.files.map(f=>cache.fs.getFile(f)).cisort("name").forEach(f=>{if(!f.deleted||"trash"===folder.role){const i=new WDICON({node:f,type:"file",label:f.name,id:f.id});$list.append(i.get())}}),$c.append($list),"trash"===folder.role?$w.on("contextmenu",e=>{trashCM(e)}):$w.on("contextmenu",e=>{folderCM(e)}),setTimeout(()=>{glob.dd.get("wd-icon").droppable($w)},1),$w},svgByFs=o=>{const out={};if(o.role)switch(o.role){case"trash":return out.lock=out.icon=getIcon("wd-trash"),out;case"root":return out.lock=out.icon=cache.wd.appIcon(),out}return o.id.startsWith("dir-")?out.icon=getIcon("wd-folder"):out.icon=getIcon("wd-file"),out},folderCM=e=>{e.preventDefault(),e.stopPropagation();const o={content:[]};o.highlight=$(e.target),o.highlight.is(".wd-icon,.wd-folder-window")||(o.highlight=o.highlight.closest(".wd-icon,.wd-folder-window"));var isIcon=o.highlight.is(".wd-icon");let f=cache.fs.getDir(o.highlight.attr("fsid"));o.content.push(f.name.escape(),{label:getLabel("wd-open-info"),action:()=>{cache.wd.folderInfo(f.id)}}),f.deleted||(isIcon?o.content.push({label:getLabel("wd-open-folder"),action:()=>{cache.wd.openFolder(f.id)}},"-"):(o.content.push({icon:getIcon("wd-folder-plus"),label:getLabel("wd-folder-create"),action:()=>{cache.wd.createFolder(f.id)}},"-"),f.parent&&o.content.push({icon:getIcon("wd-parent-folder"),label:getLabel("wd-parent-folder"),action:()=>{cache.wd.openFolder(f.parent)}},"-"))),f.role||(f.deleted?o.content.push({icon:getIcon("wd-folder"),label:getLabel("wd-trash-putback"),action:()=>{cache.wd.untrashItem(f)}}):o.content.push({icon:getIcon("wd-trash"),label:getLabel("wd-move-to-trash"),action:()=>{cache.wd.trashItem(f)}})),glob.menu(e.originalEvent||e,o)},trashCM=e=>{e.preventDefault(),e.stopPropagation();const o={content:[]};o.highlight=$(e.target),o.highlight.is(".wd-icon,.wd-folder-window")||(o.highlight=o.highlight.closest(".wd-icon,.wd-folder-window"));let f=cache.fs.getDir(o.highlight.attr("fsid"));var isIcon=o.highlight.is(".wd-icon");o.content.push(f.name.escape()),isIcon&&o.content.push({label:getLabel("wd-open-trash"),action:()=>{cache.wd.openFolder(f.id)}},"-"),o.content.push({icon:getIcon("wd-trash"),label:getLabel("wd-empty-trash"),action:()=>{cache.wd.emptyTrash()}}),glob.menu(e.originalEvent||e,o)},WDICON=class{#prop;constructor(options){this.#prop={options:options},this.#prop.label=options.label||"No name",this.#prop.type=options.type,!this.#prop.type&&options.node&&options.node.id&&(options.node.id.startsWith("dir-")?this.#prop.type="folder":options.node.id.startsWith("file-")&&(this.#prop.type="file")),this.#prop.type||(this.#prop.type="file");var svg=options.node?svgByFs(options.node):{};this.#prop.svg=options.svg||svg.icon,this.#prop.subsvg=options.subsvg||svg.subicon}get(){return this.#prop.render||(this.#prop.render=WDICON.render(this,this.#prop)),this.#prop.render}click(e){e&&"object"==typeof e&&e.target&&(e.preventDefault(),e.stopPropagation());const $w=this.get();$(`.wd-icon:not([fsid="${$w.attr("fsid")}"])`,$w.closest(".mabro-wrap")).removeClass("wd-selected"),$w.toggleClass("wd-selected"),this.#prop.options.onclick&&this.#prop.options.onclick(e)}contextmenu(e){e&&(e.preventDefault(),e.stopPropagation()),cache.wd.selectIconByFsId(),this.#prop.options.oncontextmenu?this.#prop.options.oncontextmenu(e):"folder"===this.#prop.type&&folderCM(e)}dblclick(e){e&&(e.preventDefault(),e.stopPropagation()),cache.wd.selectIconByFsId(),this.#prop.options.ondblclick?this.#prop.options.ondblclick(e):"folder"===this.#prop.type&&this.#prop.options.node&&cache.wd.openFolder(this.#prop.options.node.id)}static render(obj,p){const $d=$('<div class="wd-icon"></div>'),$svg=$('<div class="icon"></div>').append(p.svg);return p.subsvg&&$svg.append($('<div class="sub-icon"></div>').append(p.subsvg)),$d.append($svg),$d.append($('<div class="label"></div>').append($("<label></label>").append(p.label.escape()))),$d.attr("title",p.label),p.options.node&&$d.attr("fsid",p.options.node.id),p.type&&($d.attr("fstype",p.type),"folder"===p.type&&setTimeout(()=>{glob.dd.get("wd-icon").droppable($d)},1)),p.options.css&&$d.css(p.options.css),$d.on("click",e=>{obj.click(e)}),$d.on("contextmenu",e=>{obj.contextmenu(e)}),$d.on("dblclick",e=>{obj.dblclick(e)}),!p.options.nodrag&&p.options.node&&setTimeout(()=>{glob.dd.get("wd-icon").draggable($d,p.options.node)},1),$d}},getClass=async manifest=>{return class{#prop;#api;#mb;#wrap;#fs;#sysapi;constructor(api,options){options.theme||(options.theme="default"),this.#prop={options:options,manifest:manifest},this.#api=api,this.#mb=options.system,this.#sysapi=options.sysapi,this.#wrap=options.wrap,this.#mb.loadCSS(`${this.#prop.manifest.base_uri}themes/${this.#prop.options.theme}/style.css`),this.#wrap.addClass("mabro-webdesktop mabro-active")}appIcon(){return this.#prop.manifest.app_icon}async init(){var trash;glob.localize.loaded?((cache.wd=this).#fs=await this.#mb.getFs(),cache.fs=this.#fs,trash=this.#fs.getRoot(),this.#prop.mainicon=new WDICON({node:trash,label:trash.name,svg:this.#prop.manifest.app_icon,type:"folder",id:trash.id,css:{position:"absolute",top:"40px",right:"40px"},nodrag:!0}),this.#wrap.append(this.#prop.mainicon.get()),trash=this.#fs.getTrash(),this.#prop.trashicon=new WDICON({node:trash,label:trash.name,svg:getIcon("wd-trash"),type:"folder",id:trash.id,css:{position:"absolute",bottom:"40px",right:"40px"},oncontextmenu:e=>{trashCM(e)},nodrag:!0}),this.#wrap.append(this.#prop.trashicon.get()),$(".mabro-main-wrap").on("click",()=>{this.selectIconByFsId()}).on("contextmenu",e=>{if($(e.target).hasClass("mabro-main-wrap")){e.preventDefault();const app=this.#mb.apps()[$(document.body).data("mabro").activeApp];app&&this.#mb.getMenu().then(m=>{m.appContextMenu(e,e.target,app)})}})):setTimeout(()=>{this.init()},100)}async event(name,data){if("run"===name||"activate"===name)return"activate"===name&&this.#wrap.trigger("click"),this.#wrap}async openFolder(id){"object"==typeof id&&(id=id.id);let $w=$(`.wd-folder-window[fsid="${id}"]`,this.#wrap);if(!$w.length){const f=this.#fs.getDir(id);if(!f)return;const w=this.#api.newWindow({title:f.name.escape(),width:"320px",height:"160px",minWidth:"240px",minHeight:"140px"});makeFolderWindow(w,f),w.show(),$w=w.wrap()}return $w.trigger("mouseup"),$w}async folderInfo(f){"object"==typeof f&&(f=f.id);f=this.#fs.getDir(f);f&&this.itemInfo("folder",f)}async itemInfo(type,data){const dlog=await this.#api.dialog({title:data.name.escape()}),$c=$(`<div class="input-group mb-3"><input class="form-control wd-item-name" type="text" /><div class="input-group-append"><button type="button" class="btn btn-secondary btn-rename">${getLabel("wd-item-rename")}</button></div></div>`),renameFunc=()=>{let n=$("input.wd-item-name",$c).val().normalizespace();if(n.length){if("folder"===type)data.name=n,this.#fs.setDir(data);else{if("file"!==type)return;data.name=n,this.#fs.setFile(data)}$(`.wd-icon[fsid="${data.id}"] div.label label`,this.#wrap).html(n.escape()),$(`.wd-folder-window[fsid="${data.id}"]>.mabro-window-titlebar>label`,this.#wrap).html(n.escape()),data.parent&&this.refreshWindowByFsid(data.parent),dlog.close()}else $("input.wd-item-name",$c).val(data.name).select()};$("input.wd-item-name",$c).val(data.name),$("button.btn-rename",$c).on("click",()=>{renameFunc()}),dlog.body($c),dlog.footer().remove(),dlog.show(()=>{$("input.wd-item-name",$c).select()})}async createFolder(parentid){"object"==typeof parentid&&(parentid=parentid.id);let parent=this.#fs.getDir(parentid);if(parent){const dlog=await this.#api.dialog({title:"In: "+parent.name.escape()}),$c=$(`<div class="input-group mb-3"><input class="form-control wd-item-name" type="text" /><div class="input-group-append"><button type="button" class="btn btn-secondary btn-create">${getLabel("wd-item-create")}</button></div></div>`),createFunc=()=>{var data=$("input.wd-item-name",$c).val().normalizespace();data.length&&(data={name:data,id:glob.uid("dir-"),parent:parentid},this.#fs.setDir(data),Array.isArray(parent.dirs)||(parent.dirs=[]),parent.dirs.push(data.id),this.#fs.setDir(parent),this.refreshWindowByFsid(parent.id),dlog.close())};$("button.btn-create",$c).on("click",()=>{createFunc()}),dlog.body($c),dlog.footer().remove(),dlog.show(()=>{$("input.wd-item-name",$c).focus()})}}trashItem(oid){var type=(oid="object"==typeof oid?oid.id:oid).startsWith("dir-")?"folder":"file";const o="folder"==type?this.#fs.getDir(oid):this.#fs.getFile(oid);o.deleted=!0;const t=this.#fs.getTrash();"folder"==type?(this.#fs.setDir(o),Array.isArray(t.dirs)||(t.dirs=[]),t.dirs.push(oid)):(this.#fs.setFile(o),Array.isArray(t.files)||(t.files=[]),t.files.push(oid)),this.#fs.setDir(t),this.closeWindowByFsid(oid),this.refreshWindowByFsid(o.parent),this.refreshWindowByFsid(t.id)}untrashItem(oid){var type=(oid="object"==typeof oid?oid.id:oid).startsWith("dir-")?"folder":"file";const o="folder"==type?this.#fs.getDir(oid):this.#fs.getFile(oid);delete o.deleted;const t=this.#fs.getTrash();if(!this.#fs.getDir(o.parent)){const root=this.#fs.getRoot();o.parent=root.id,"folder"==type?(root.dirs||(root.dirs=[]),root.dirs.push(o.id)):(root.files||(root.files=[]),root.files.push(o.id)),this.#fs.setDir(root)}"folder"==type?(this.#fs.setDir(o),t.dirs=t.dirs.filter(id=>id!==oid)):(this.#fs.setFile(o),t.files=t.files.filter(id=>id!==oid)),this.#fs.setDir(t),this.refreshWindowByFsid(o.parent),this.refreshWindowByFsid(t.id),this.selectIconByFsId(o.id)}emptyTrash(){const t=this.#fs.getTrash();Array.isArray(t.dirs)&&t.dirs.forEach(d=>{this.#fs.rmDir(d)}),Array.isArray(t.files)&&t.files.forEach(f=>{this.#fs.rmFile(f)}),delete t.dirs,delete t.files,this.#fs.setDir(t),this.closeWindowByFsid(t.id),this.selectIconByFsId()}selectIconByFsId(fsid){fsid?($(`.wd-icon:not([fsid="${fsid}"])`,this.#wrap).removeClass("wd-selected"),$(`.wd-icon[fsid="${fsid}"]`,this.#wrap).addClass("wd-selected")):$(".wd-icon",this.#wrap).removeClass("wd-selected")}closeWindowByFsid(fsid){$(`.wd-folder-window[fsid="${fsid}"]`,this.#wrap).each((idx,w)=>{this.#api.closeWindow($(w).attr("id"))})}refreshWindowByFsid(fsid){$(`.wd-folder-window[fsid="${fsid}"]`,this.#wrap).each((idx,wobj)=>{wobj=this.winById($(wobj).attr("id"));wobj&&makeFolderWindow(wobj,this.#fs.getDir(fsid))})}winById(id){return this.#sysapi.winById(id)}async refresh(){}}};export default getClass;